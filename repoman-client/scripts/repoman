#!/usr/bin/env python
import sys
import argparse
import os
sys.path.append('../')
sys.path.append('./')
from repoman_client import repoman_client

repo = repoman_client.repoman_client()

parser = argparse.ArgumentParser(description='Client for Repoman image repository.')

def ask_yes_or_no(*args, **kwargs):
    try:
        force = kwargs['force']
    except:
        force = False
    print " Are you sure you want to continue?"
    if force:
        print " To prevent this message from displaying, run the command with" 
        print " --force or -f."
    k=raw_input("[y/N]")
    if k in ('y', 'ye', 'yes'):
        return True
    return False
    

def print_help_menu():
    print "repoman-client 0.1.2"
    print "root help menu (pre-subcommand)"
    sys.exit(0)

def main():
    if not len(sys.argv) > 1:
        print_help_menu()
        sys.exit(0)
    else:
        command = sys.argv[1]
        


    if command == 'list-images':
        # DONE
        parser.add_argument('--long', action='store_true', default=False)
        parser.add_argument('--sharedwith', action='store')
        parser.add_argument('--all', action='store_true', default=False)
        parser.add_argument('--user', action='store')
        parser.add_argument('--group', action='store')
        args = parser.parse_args(args=sys.argv[2:])
        if args.all:
        
            repo.list_all_images()
        elif not args.user is None:
            if args.long:
                repo.list_user_images(args.user, args.long)
            else:
                repo.list_user_images(args.user, args.long)
        
        else:
            if args.long:
                repo.list_images(args.long)
            else:
                repo.list_images(args.long)
        
        sys.exit(0)

    if command == 'list-users':
        parser.add_argument('--long', action='store_true', default=False)
        parser.add_argument('--group', action='store')
        args = parser.parse_args(args=sys.argv[2:])
        if not args.group is None:
            repo.list_group_members(args.long, args.group)
        else:
            repo.list_users(args.long)
        sys.exit(0)
        
        
    if command == 'list-groups':
    	#DONE
        parser.add_argument('--long', action='store_true', default=False)
        #parser.add_argument('--group', action='store')
        args = parser.parse_args(args=sys.argv[2:])
        repo.list_groups(args.long)
        sys.exit(0)
        

    if command == 'whoami':
        # long
        if options.long:
            repo.get_user()
        else:
            repo.get_username()
        sys.exit(0)
    
    if command == 'view-user':
        sys.exit(0)
       
        
        
    if command == 'create-group':
        # --metavar value
        
        print 'todo'
        #repo.create_group(args)
        sys.exit(0)
        
        
    if command == 'create-user':
        # --metavar value
        
        print 'todo'
        #repo.create_user(args)
        sys.exit(0)
        
        
    if command == 'modify-user':
        # --user USERNAME [--METAVAR VALUE ...]
        
        print 'todo'
        #repo.modify_user(args)
        sys.exit(0)
        
        
    if command == 'modify-group':
        # --group GROUPNAME [--METAVAR VALUE ...]
        
        print 'todo'
        #repo.modify_group(args)
        sys.exit(0)
        
        
    if command == 'modify-image':
        # [USER/]IMAGE [--METAVAR VALUE ...]
        parser.add_argument('image')
        args = parser.parse_known_args(args=sys.argv[2:])
        image = args[0].image
        metadata = dict([(args[1][i].strip('-'), args[1][i+1]) for i in range(0, len(args[1]) - 1, 2)])
        metadata['name'] = image
        #Server is expecting Bool objects for readonly
        try:
            readonly = metadata['readonly']
            true_values = ['t', 'True', 'true']
            if true_values.count(metadata['readonly']):
                metadata['readonly'] = True
            else:
                metadata['readonly'] = False
        
        except:
            metadata['readonly'] = False
            
        print "Updating image "+metadata['name']+" with metadata: "
        for key in metadata:
             print key+": "+str(metadata[key])
        repo.update_metadata(metadata=metadata, exists=True)
        sys.exit(0)

        
    if command == 'download-image':
        # --image [USER/]IMAGE [--dest DEST]
        
        list_image_names()
        if not options.name:
            print "Please enter on of the following names:"
            for item in image_list:
                print item
        else:
            exists = False
            for item in image_list:
                if item == options.name:
                    exists = True
            if exists:
                if options.path:
                    repo.get(name=options.name,path=options.path)
                else:
                    repo.get(name=options.name)
            else: 
               print "Image did not match any of your images on the server."
               print "Please enter on of the following names:"           
               for item in image_list:
                   print item
        sys.exit(0)             
        
        
        
    if command == 'view-image':
        # --image [USER/]IMAGE
        
        repo.list_images(False)

        parser.add_option('-n','--name',action="store",type="string",dest="name")
        options, args = parser.parse_args(args=sys.argv[2:])
        if options.name:
            resp = repo.get_image_info(options.name)
            print '\n'
            for key in resp:
                print "  "+key+": \t",
                print str(resp[key])
            print '\n'
            sys.exit(0)           
        else:
            print "Please run this command as info --name image_name, where image_name is one of the following:"
            for item in image_list:
                print item
            sys.exit(2)
        sys.exit(0)
        
    
    
        
        
    if command == 'create-image':
        # [--file FILE] [--METAVAR VALUE ...]
        parser.add_argument('--file', action='store')
        args = parser.parse_known_args(args=sys.argv[2:])
        metadata = dict([(args[1][i].strip('-'), args[1][i+1]) for i in range(0, len(args[1]) - 1, 2)])
        #Server is expecting Bool objects for readonly
        try:
            readonly = metadata['readonly']
            true_values = ['t', 'True', 'true']
            if true_values.count(metadata['readonly']):
                metadata['readonly'] = True
            else:
                metadata['readonly'] = False
        
        except:
            metadata['readonly'] = False
        try:
            try:
                name = metadata['name']
            except:
                metadata['name'] = args[0].file
                name = metadata['name']
        except:
            print "Please enter either a filename or a name as part of the metadata."
            sys.exit(1)            
        
        print "Creating image "+name+" with metadata: "
        for key in metadata:
            print key+": "+str(metadata[key])
        repo.update_metadata(metadata=metadata, replace=False)
        if args[0].file is not None:
            print "Uploading image file "+args[0].file+'...'
            if not os.path.isfile(args[0].file):
                print "The file you specified does not exist."
                sys.exit(1)
            else:
                repo.upload_image(args[0].file, name=metadata['name'], metadata=metadata)
                sys.exit(0)
                
            
        sys.exit(0)
        
    if command == 'share-image':
        # --name [USER/]NAME (--user USER | --group GROUP)
                
        if not options.username and not options.group:
            print "Please user either a user or a group to share the image with."
            print "i.e. share --user username or share --group groupname --name imagename"
            sys.exit(0)
        if options.username and options.group:
            print "Please select either a user or a group to share to."
            sys.exit(0)
        if not options.image:
            image_list = repo.list_images_raw()
            for i in xrange(len(repo.list_images_raw())):
                image_list[i] = repo.list_images_raw()[i].split('/')[6]
            print "Please enter an image to share."
            print "i.e. share --user username --name imagename"
            print "The images you own on the server are:"
            for item in image_list:
                print item
            sys.exit(2)
        if options.username:
            repo.share_user(user=options.username,image=options.image)
            sys.exit(0)
        if options.group:
            repo.share_group(group=options.group,image=options.image)
            sys.exit(0)
        sys.exit(0)
        
                
    if command == 'unshare-image':
        # --name [USER/]NAME (--user USER | --group GROUP)
        
        image_list = repo.list_images_raw()
        for i in xrange(len(repo.list_images_raw())):
            image_list[i] = repo.list_images_raw()[i].split('/')[6]
        if not options.username and not options.group:
            print "Please user either a user or a group to unshare the image with."
            print "i.e. unshare --user username or unshare --group groupname --name imagename"
            sys.exit(0)
        if options.username and options.group:
            print "Please select either a user or a group to unshare to."
            sys.exit(0)
        if not options.image:
            print "Please enter an image to unshare."
            print "i.e. unshare --user username --name imagename"
            print "The images you own on the server are:"
            for item in image_list:
                print item
            sys.exit(0)
        exists = False
        for item in image_list:
            if item == options.image:
                exists = True
        if not exists:
            print "That image does not exist on the repository."
            print "The images you own on the server are:"
            for item in image_list:
                print item
            sys.exit(0) 
        if options.username:    
            repo.unshare_user(user=options.username,image=options.image)
            sys.exit(2)
        if options.group:
            repo.unshare_group(group=options.group,image=options.image) 
            sys.exit(2)
        sys.exit(0)
        
        
        name
        
    if command == 'delete-image':
    
        if not options.name:
            print "Please specify a name with --name image_name"
            sys.exit(0)
        image_list = repo.list_images_raw()
        exists = False
        for i in xrange(len(repo.list_images_raw())):
            image_list[i] = repo.list_images_raw()[i].split('/')[6]
            if image_list[i] == options.name:
                exists = True
        if not exists:
            print "That image does not exist on the repository."
        else:
            print "Deleting image "+options.name
            if options.force:
                repo.delete(options.name)
                sys.exit(2)
            if ask_yes_or_no(force=options.force):
                repo.delete(options.name)
            else:
                print "Exiting repoman."
                sys.exit(0)
        sys.exit(0)
        
        
    if command == 'snapshot-image':
        # --noupload --METAVARS VALUE
        
        image_list = repo.list_images_raw()
        for i in xrange(len(repo.list_images_raw())):
            image_list[i] = repo.list_images_raw()[i].split('/')[6]

        try:
            name = metadata['name']

        except:
            print '''    Please either specify an image name with the --name flag
        or specify metadata with --name [name] --os_type [os_type] etc..
        The images available to you are:
                  ''' 
            for item in image_list:
                print item
            print '''
        select one of these images to overwrite, or specify a new image name
        see --help for more details
                  '''
            sys.exit(2)
        replace=False
        for item in image_list:
            if item == name:
                replace=True
                if not force:
                    print 'WARNING!! This image already exists on the repository.'
                    if not ask_yes_or_no(force=True):
                        print 'Exiting repoman-client.'
                        sys.exit(2)
        print "Saving image "+name+" with the following metadata:"
        for key in metadata:
            print key+": "+metadata[key]
        repo.save_image(metadata=metadata,replace=replace)
        sys.exit(0)
        
        
        
    if command == 'upload-image':
        # --name NAME --METAVARS VALUE
        
        try:
            file = metadata['file']
            del metadata['file']
        except:
            print "Please specify a file to upload with --file file_name"
            sys.exit(0)
        if not os.path.isfile(file):
            print "The file "+file+" does not exist.  Please try again."
            sys.exit(0)
        try:
            name = metadata['name']
        except:
            print "The minimum metadata needed to upload an image is the name, specified with --name"
            sys.exit(0)
        
        #Server is expecting Bool objects for readonly
        try:
            readonly = metadata['readonly']
            true_values = ['t', 'True', 'true']
            if true_values.count(metadata['readonly']):
                metadata['readonly'] = True
            else:
                metadata['readonly'] = False
        except:
            metadata['readonly'] = False
        image_list = repo.list_images_raw()
        for i in xrange(len(repo.list_images_raw())):
            image_list[i] = repo.list_images_raw()[i].split('/')[6]
        print "Uploading..."
        replace=False
        for item in image_list:
            if item == metadata['name']:
                replace=True
                print 'WARNING!! This image already exists on the repository.'
                if not ask_yes_or_no():
                    print 'Exiting repoman-client.'
                    sys.exit(2)
        repo.upload_image(file, replace=replace, name=name, metadata=metadata)
        sys.exit(0)
        
        
        
    if command == 'group-add-user':
        # --group GROUP --user USER
        
        print 'todo'
        #repo.group_add_user(args)
        sys.exit(0)
        
    if command == 'group-rm-user':
        # --group GROUP --user NAME
        
        print 'todo'
        #repo.group_rm_user(args)
        sys.exit(0)
        
    if command == 'group-add-perm':
        # --group GROUP --perm PERM
        
        print 'todo'
        #repo.group_add_perm(args)
        sys.exit(0)
        
    if command == 'group-rm-perm':
        # --group GROUP --perm PERM
        
        print 'todo'
        #repo.group_rm_perm(args)
        sys.exit(0)
                

    if command == 'help' or command == '--help':
        print_help_menu()
        sys.exit(0)
    
    else:
        print "Command not recognized."
        print_help_menu()
        sys.exit(0)

if __name__ == "__main__":
    main() 
